# Fleet configuration for EKS Pod Identity Agent deployment
# Deploys to kube-system namespace on all downstream EKS clusters

namespace: kube-system

helm:
  # Use the Helm chart directly from the GitHub repository using go-getter git URL format
  # Fleet will clone the repo and navigate to the charts/eks-pod-identity-agent subdirectory
  chart: git::https://github.com/aws/eks-pod-identity-agent.git//charts/eks-pod-identity-agent?ref=main

  # Release name for the Helm deployment
  releaseName: eks-pid-agent

  # Default values applied to all clusters
  values:
    # Default values - these will be overridden by targetCustomizations per cluster
    clusterName: "PLACEHOLDER"
    env:
      AWS_REGION: "us-east-1"

# Per-cluster customizations
# Fleet will set cluster-specific values based on cluster labels
targetCustomizations:
  # Dynamically set cluster-specific values using Fleet's cluster label variables
  # Assumes clusters have labels: cluster-name=<eks-cluster-name> and aws-region=<region>
  - name: eks-clusters
    clusterSelector:
      matchLabels:
        cluster-type: eks
    helm:
      values:
        # Reference cluster labels via Fleet's template variables
        clusterName: ${ index .ClusterLabels "cluster-name" }
        env:
          AWS_REGION: ${ index .ClusterLabels "aws-region" }
