# Fleet configuration for ACK IAM Controller with Pod Identity
# Uses package-built Helm chart from Helm repository
# PodIdentityAssociation is created declaratively by the chart

defaultNamespace: ack-system

helm:
  # Use the Helm chart from the Helm repository
  chart: iam-chart
  repo: https://ravan.github.io/mcm-eks-fleet-blueprints/
  version: 1.5.201+up1.5.2
  releaseName: ack-iam-controller

# Per-cluster customizations
targetCustomizations:
  - name: eks-clusters
    clusterSelector:
      matchLabels:
        cluster-type: eks
    helm:
      values:
        # Inject cluster-specific values from Fleet cluster labels
        clusterName: ${ index .ClusterLabels "cluster-name" }
        awsRegion: ${ index .ClusterLabels "aws-region" }
        awsAccountId: ${ index .ClusterLabels "aws-account-id" | quote }
        ackIamRoleName: ${ default "MCMACKIAMControllerRole" (get .ClusterLabels "ack-iam-role-name") }

        # Pass AWS region to the chart
        aws:
          region: ${ index .ClusterLabels "aws-region" }

        # Configure Pod Identity subchart
        ack-pod-identity-association:
          fullnameOverride: "ack-iam-pi"
          controllerName: "ack-iam-controller"
          podIdentity:
            enabled: true
            name: "ack-iam-controller-pod-identity"
            clusterName: ${ index .ClusterLabels "cluster-name" }
            awsAccountId: ${ index .ClusterLabels "aws-account-id" | quote }
            roleName: ${ default "MCMACKIAMControllerRole" (get .ClusterLabels "ack-iam-role-name") }
            serviceAccountName: "ack-iam-controller"
            namespace: "ack-system"

# Dependencies: Requires ACK EKS controller to reconcile PodIdentityAssociation CRD
dependsOn:
  - name: ack-eks-controller-blueprints-ack-eks-controller
