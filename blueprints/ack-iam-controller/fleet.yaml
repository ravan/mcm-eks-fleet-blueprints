# Fleet configuration for ACK IAM Controller with Pod Identity
# Uses wrapper Helm chart that includes both the ACK controller and PodIdentityAssociation

defaultNamespace: ack-system

helm:
  # Use local wrapper Helm chart
  chart: ./chart
  releaseName: ack-iam-controller

# Per-cluster customizations
targetCustomizations:
  - name: eks-clusters
    clusterSelector:
      matchLabels:
        cluster-type: eks
    helm:
      values:
        # Inject cluster-specific values from Fleet cluster labels
        clusterName: ${ index .ClusterLabels "cluster-name" }
        awsRegion: ${ index .ClusterLabels "aws-region" }
        awsAccountId: ${ index .ClusterLabels "aws-account-id" | quote }
        ackIamRoleName: ${ default "MCMACKIAMControllerRole" (get .ClusterLabels "ack-iam-role-name") }

        # Pass region to the iam-chart subchart
        iam-chart:
          aws:
            region: ${ index .ClusterLabels "aws-region" }

# Dependencies: Requires ACK EKS controller to reconcile PodIdentityAssociation CRD
dependsOn:
  - name: ack-controllers-blueprints-ack-eks-controller

# Wait for bootstrap Job to complete before deploying controller
waitForJobs: true
