# Fleet configuration for ACK EKS Controller with Pod Identity
# Uses wrapper Helm chart that includes the ACK EKS controller as a subchart
# The bootstrap Job (in separate bundle) creates the pod identity association before this deploys

defaultNamespace: ack-system

helm:
  # Use the Helm chart from the Helm repository
  chart: eks-chart
  repo: https://ravan.github.io/mcm-eks-fleet-blueprints/
  version: 1.9.301+up1.9.3
  releaseName: ack-eks-controller

# Per-cluster customizations
targetCustomizations:
  - name: eks-clusters
    clusterSelector:
      matchLabels:
        cluster-type: eks
    helm:
      values:
        # Inject cluster-specific values from Fleet cluster labels
        clusterName: ${ index .ClusterLabels "cluster-name" }
        awsRegion: ${ index .ClusterLabels "aws-region" }
        awsAccountId: ${ index .ClusterLabels "aws-account-id" | quote }
        ackEksRoleName: ${ default "MCMACKEKSControllerRole" (get .ClusterLabels "ack-eks-role-name") }

        # Pass AWS region to the main chart
        aws:
          region: ${ index .ClusterLabels "aws-region" }

        # Pass values to the bootstrap subchart
        ack-eks-bootstrap:
          clusterName: ${ index .ClusterLabels "cluster-name" }
          awsRegion: ${ index .ClusterLabels "aws-region" }
          awsAccountId: ${ index .ClusterLabels "aws-account-id" | quote }
          ackEksRoleName: ${ default "MCMACKEKSControllerRole" (get .ClusterLabels "ack-eks-role-name") }
          namespace: "ack-system"
          serviceAccount: "ack-eks-controller"

# Dependencies: Requires Pod Identity Agent to be running
dependsOn:
  - name: eks-pod-identity-agent-blueprints-pod-identity-agent

# Wait for bootstrap Job to complete before deploying controller
waitForJobs: true
